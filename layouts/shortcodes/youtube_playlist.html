{{/*
  This shortcode displays a YouTube playlist as an accordion.
  Compatible with Hugo 0.104.1

  Usage:
  {{< youtube_playlist playlistId="PLABC123..." order="chronological" >}}

  Parameters:
  - playlistId (required): The ID of the YouTube playlist.
  - order (optional): The order of videos. Can be "chronological", "reverseChronological", or "alpha". Default is "chronological".

*/}}

{{- $playlistId := .Get "playlistId" -}}
{{- $order := .Get "order" | default "chronological" -}}
{{- $apiKey := .Get "apiKey" | default (getenv "YOUTUBE_API_KEY") -}}

{{- if not $playlistId -}}
    <div class="error">
        <p>Error: 'playlistId' parameter is required for the youtube_playlist shortcode.</p>
    </div>
{{- else if not $apiKey -}}
    <div class="error">
        <p>Error: YouTube API key not found. Please set YOUTUBE_API_KEY environment variable.</p>
    </div>
{{- else -}}
    {{- $uniqueId := printf "playlist-accordion-%s" (substr $playlistId 0 16) -}}

    <div class="youtube-playlist-accordion"
         id="{{ $uniqueId }}"
         data-api-key="{{ $apiKey }}"
         data-playlist-id="{{ $playlistId }}"
         data-order="{{ $order }}">
        <div class="loading">
            <p>Loading playlist...</p>
        </div>
    </div>

    <style>
        .youtube-playlist-accordion {
            margin: 20px 0;
        }
        .accordion-container {
            border: 1px solid #ffd700;
            padding: 15px;
            border-radius: 5px;
        }
        .playlist-header h2 {
            margin: 0 0 10px 0;
        }
        .playlist-header img {
            max-width: 200px;
            height: auto;
            margin: 10px 0;
        }
        .toggle-btn {
            background: #ffd700;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 3px;
            font-weight: bold;
        }
        .video-item {
            margin: 15px 0;
        }
        .video-title-link {
            font-weight: bold;
            color: #0066cc;
            text-decoration: none;
            display: block;
            margin-bottom: 10px;
        }
        .video-title-link:hover {
            text-decoration: underline;
        }
        .video-embed iframe {
            width: 100%;
            height: 315px;
            max-width: 560px;
        }
        .error {
            background: #ffe6e6;
            border: 1px solid #ff0000;
            padding: 10px;
            border-radius: 3px;
            color: #cc0000;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
    </style>

    <script>
        (function() {
            // Global API call queue to prevent rate limiting
            window.youtubePlaylistQueue = window.youtubePlaylistQueue || [];
            window.youtubePlaylistProcessing = window.youtubePlaylistProcessing || false;

            // Function to process API calls sequentially
            function processApiQueue() {
                if (window.youtubePlaylistProcessing || window.youtubePlaylistQueue.length === 0) {
                    return Promise.resolve();
                }
                
                window.youtubePlaylistProcessing = true;
                
                function processNext() {
                    if (window.youtubePlaylistQueue.length === 0) {
                        window.youtubePlaylistProcessing = false;
                        return Promise.resolve();
                    }
                    
                    var apiCall = window.youtubePlaylistQueue.shift();
                    return apiCall()
                        .then(function() {
                            // Add delay between API calls to prevent rate limiting
                            return new Promise(function(resolve) {
                                setTimeout(resolve, 100);
                            });
                        })
                        .catch(function(error) {
                            console.error('API call failed:', error);
                        })
                        .then(processNext);
                }
                
                return processNext();
            }

            function initializePlaylist() {
                var rootElement = document.getElementById('{{ $uniqueId }}');
                if (!rootElement) return;

                var apiKey = rootElement.getAttribute('data-api-key');
                var playlistId = rootElement.getAttribute('data-playlist-id');
                var order = rootElement.getAttribute('data-order');
                var loadingElement = rootElement.querySelector('.loading');

                var API_BASE_URL = 'https://www.googleapis.com/youtube/v3/playlistItems';
                var PLAYLISTS_API_URL = 'https://www.googleapis.com/youtube/v3/playlists';

                // Function to fetch playlist details
                function fetchPlaylistDetails() {
                    var url = PLAYLISTS_API_URL + '?part=snippet,contentDetails&id=' + playlistId + '&key=' + apiKey;
                    return fetch(url)
                        .then(function(response) {
                            if (!response.ok) {
                                return response.json().then(function(errorData) {
                                    throw new Error('YouTube API Error: ' + errorData.error.message);
                                });
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.items && data.items.length > 0) {
                                return data.items[0].snippet;
                            }
                            throw new Error('Playlist not found');
                        })
                        .catch(function(error) {
                            console.error('Error fetching playlist details:', error);
                            displayError(error.message);
                            return null;
                        });
                }

                // Function to fetch playlist items
                function fetchPlaylistItems(nextPageToken) {
                    var url = API_BASE_URL + '?part=snippet,contentDetails&playlistId=' + playlistId + '&key=' + apiKey + '&maxResults=50';
                    if (nextPageToken) {
                        url += '&pageToken=' + nextPageToken;
                    }

                    return fetch(url)
                        .then(function(response) {
                            if (!response.ok) {
                                return response.json().then(function(errorData) {
                                    throw new Error('YouTube API Error: ' + errorData.error.message);
                                });
                            }
                            return response.json();
                        })
                        .catch(function(error) {
                            console.error('Error fetching playlist items:', error);
                            displayError(error.message);
                            return null;
                        });
                }

                // Function to display an error message
                function displayError(message) {
                    if (loadingElement && loadingElement.parentNode) {
                        loadingElement.parentNode.removeChild(loadingElement);
                    }
                    var errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.innerHTML = '<p>Failed to load YouTube playlist: ' + message + '</p>';
                    rootElement.appendChild(errorDiv);
                }

                // Function to truncate description at Charleston Church URL
                function truncateDescription(description) {
                    if (!description) return 'No description available.';
                    
                    var charlestonRegex = /https?:\/\/charlestonchurch/i;
                    var match = description.match(charlestonRegex);
                    
                    if (match) {
                        return description.substring(0, match.index).trim();
                    }
                    
                    return description;
                }

                // Function to render the playlist accordion
                function renderPlaylist() {
                    return new Promise(function(resolve, reject) {
                        var apiCall = function() {
                            return fetchPlaylistDetails()
                                .then(function(playlistDetails) {
                                    if (!playlistDetails) {
                                        throw new Error('Failed to fetch playlist details');
                                    }

                                    var allVideos = [];
                                    
                                    function fetchAllPages(pageToken) {
                                        return fetchPlaylistItems(pageToken)
                                            .then(function(data) {
                                                if (!data) {
                                                    throw new Error('Failed to fetch playlist items');
                                                }
                                                allVideos = allVideos.concat(data.items);
                                                if (data.nextPageToken) {
                                                    return fetchAllPages(data.nextPageToken);
                                                }
                                                return allVideos;
                                            });
                                    }
                                    
                                    return fetchAllPages().then(function() {
                                        if (loadingElement && loadingElement.parentNode) {
                                            loadingElement.parentNode.removeChild(loadingElement);
                                        }

                                        // Sort videos based on the 'order' parameter
                                        if (order === "reverseChronological") {
                                            allVideos.sort(function(a, b) {
                                                return new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt);
                                            });
                                        } else if (order === "alpha") {
                                            allVideos.sort(function(a, b) {
                                                return a.snippet.title.localeCompare(b.snippet.title);
                                            });
                                        } else { // default to chronological
                                            allVideos.sort(function(a, b) {
                                                return new Date(a.snippet.publishedAt) - new Date(b.snippet.publishedAt);
                                            });
                                        }

                                        // Create main accordion container
                                        var accordionContainer = document.createElement('div');
                                        accordionContainer.className = 'accordion-container';

                                        // Create playlist header
                                        var playlistHeader = document.createElement('div');
                                        playlistHeader.className = 'playlist-header';
                                        playlistHeader.innerHTML = 
                                            '<h2>' + playlistDetails.title + '</h2>' +
                                            '<img src="' + playlistDetails.thumbnails.medium.url + '" alt="' + playlistDetails.title + '">' +
                                            '<button class="toggle-btn">Show ' + playlistDetails.title + ' Videos</button>';

                                        // Create videos container
                                        var videosContainer = document.createElement('div');
                                        videosContainer.className = 'videos-container';
                                        videosContainer.style.display = 'none';

                                        // Create video items
                                        for (var i = 0; i < allVideos.length; i++) {
                                            var video = allVideos[i];
                                            var videoItem = document.createElement('div');
                                            videoItem.className = 'video-item';
                                            
                                            var videoTitle = document.createElement('a');
                                            videoTitle.href = '#';
                                            videoTitle.textContent = 'Video Title: ' + video.snippet.title;
                                            videoTitle.className = 'video-title-link';
                                            
                                            var publishDate = new Date(video.snippet.publishedAt).toLocaleDateString();
                                            var truncatedDescription = truncateDescription(video.snippet.description);
                                            
                                            var videoMeta = document.createElement('div');
                                            videoMeta.className = 'video-meta-info';
                                            videoMeta.innerHTML = 
                                                '<p><strong>Published:</strong> ' + publishDate + '</p>' +
                                                '<p><strong>Description:</strong> ' + truncatedDescription + '</p>';
                                            
                                            var videoEmbed = document.createElement('div');
                                            videoEmbed.className = 'video-embed';
                                            videoEmbed.style.display = 'none';
                                            videoEmbed.innerHTML = 
                                                '<iframe src="https://www.youtube.com/embed/' + video.contentDetails.videoId + '?autoplay=1" ' +
                                                'frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
                                                'allowfullscreen></iframe>';
                                            
                                            // Add click event to video title
                                            (function(meta, embed) {
                                                videoTitle.addEventListener('click', function(e) {
                                                    e.preventDefault();
                                                    if (embed.style.display === 'none') {
                                                        meta.style.display = 'none';
                                                        embed.style.display = 'block';
                                                    } else {
                                                        meta.style.display = 'block';
                                                        embed.style.display = 'none';
                                                    }
                                                });
                                            })(videoMeta, videoEmbed);
                                            
                                            videoItem.appendChild(videoTitle);
                                            videoItem.appendChild(videoMeta);
                                            videoItem.appendChild(videoEmbed);
                                            
                                            if (i < allVideos.length - 1) {
                                                var hr = document.createElement('hr');
                                                hr.style.borderColor = '#ffd700';
                                                hr.style.borderWidth = '1px';
                                                videoItem.appendChild(hr);
                                            }
                                            
                                            videosContainer.appendChild(videoItem);
                                        }

                                        // Add toggle functionality
                                        var toggleBtn = playlistHeader.querySelector('.toggle-btn');
                                        toggleBtn.addEventListener('click', function() {
                                            if (videosContainer.style.display === 'none') {
                                                videosContainer.style.display = 'block';
                                                toggleBtn.textContent = 'Hide ' + playlistDetails.title + ' Videos';
                                            } else {
                                                videosContainer.style.display = 'none';
                                                toggleBtn.textContent = 'Show ' + playlistDetails.title + ' Videos';
                                                
                                                var allVideoEmbeds = videosContainer.querySelectorAll('.video-embed');
                                                var allVideoMeta = videosContainer.querySelectorAll('.video-meta-info');
                                                for (var j = 0; j < allVideoEmbeds.length; j++) {
                                                    allVideoEmbeds[j].style.display = 'none';
                                                }
                                                for (var k = 0; k < allVideoMeta.length; k++) {
                                                    allVideoMeta[k].style.display = 'block';
                                                }
                                            }
                                        });

                                        accordionContainer.appendChild(playlistHeader);
                                        accordionContainer.appendChild(videosContainer);
                                        rootElement.appendChild(accordionContainer);
                                        
                                        resolve();
                                    });
                                })
                                .catch(function(error) {
                                    console.error('Error in renderPlaylist:', error);
                                    displayError(error.message);
                                    reject(error);
                                });
                        };
                        
                        window.youtubePlaylistQueue.push(apiCall);
                        processApiQueue();
                    });
                }

                // Start the rendering process
                renderPlaylist().catch(function(error) {
                    console.error('Failed to render playlist:', error);
                });
            }

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePlaylist);
            } else {
                initializePlaylist();
            }
        })();
    </script>
{{- end -}}