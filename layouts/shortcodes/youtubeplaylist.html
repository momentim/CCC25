{{/*
  This shortcode displays a YouTube playlist as an accordion.

  Usage:
  {{< youtube_playlist playlistId="PLABC123..." order="chronological" >}}

  Parameters:
  - playlistId (required): The ID of the YouTube playlist.
  - order (optional): The order of videos. Can be "chronological", "reverseChronological", or "alpha". Default is "chronological".

*/}}

{{ $playlistId := .Get "playlistId" }}
{{ $order := .Get "order" | default "chronological" }}
{{ $apiKey := .Get "apiKey" | default (site.Params.youtube_api_key | default (getenv "YOUTUBE_API_KEY")) }}

{{ if not $playlistId }}
    <div class="error">
        Error: 'playlistId' parameter is required for the youtube_playlist shortcode.
    </div>
{{ else if not $apiKey }}
    <div class="error">
        Error: 'apiKey' parameter is required for the youtube_playlist shortcode.
        Please provide your YouTube Data API Key.
    </div>
{{ else }}
    {{ $uniqueId := printf "playlist-accordion-%s-%d" (substr $playlistId 0 16) now.UnixNano }}

    <div class="youtube-playlist-accordion"
         id="{{ $uniqueId }}"
         data-api-key="{{ $apiKey }}"
         data-playlist-id="{{ $playlistId }}"
         data-order="{{ $order }}">
        <div class="loading">
            <p>Loading playlist...</p>
        </div>
    </div>

    <script>
        // Global API call queue to prevent rate limiting
        window.youtubePlaylistQueue = window.youtubePlaylistQueue || [];
        window.youtubePlaylistProcessing = window.youtubePlaylistProcessing || false;

        // Function to process API calls sequentially
        async function processApiQueue() {
            if (window.youtubePlaylistProcessing || window.youtubePlaylistQueue.length === 0) {
                return;
            }
            
            window.youtubePlaylistProcessing = true;
            
            while (window.youtubePlaylistQueue.length > 0) {
                const apiCall = window.youtubePlaylistQueue.shift();
                try {
                    await apiCall();
                    // Add delay between API calls to prevent rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    console.error('API call failed:', error);
                }
            }
            
            window.youtubePlaylistProcessing = false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const rootElement = document.getElementById('{{ $uniqueId }}');
            if (!rootElement) return;

            const apiKey = rootElement.dataset.apiKey;
            const playlistId = rootElement.dataset.playlistId;
            const order = rootElement.dataset.order;
            const loadingElement = rootElement.querySelector('.loading');

            const API_BASE_URL = 'https://www.googleapis.com/youtube/v3/playlistItems';
            const PLAYLISTS_API_URL = 'https://www.googleapis.com/youtube/v3/playlists';

            // Function to fetch playlist details (title, description, thumbnail)
            async function fetchPlaylistDetails() {
                const url = `${PLAYLISTS_API_URL}?part=snippet,contentDetails&id=${playlistId}&key=${apiKey}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`YouTube API Error: ${errorData.error.message}`);
                    }
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        return data.items[0].snippet;
                    }
                    throw new Error('Playlist not found');
                } catch (error) {
                    console.error('Error fetching playlist details:', error);
                    displayError(error.message);
                    return null;
                }
            }

            // Function to fetch playlist items
            async function fetchPlaylistItems(nextPageToken = '') {
                let url = `${API_BASE_URL}?part=snippet,contentDetails&playlistId=${playlistId}&key=${apiKey}&maxResults=50`;
                if (nextPageToken) {
                    url += `&pageToken=${nextPageToken}`;
                }

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`YouTube API Error: ${errorData.error.message}`);
                    }
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching playlist items:', error);
                    displayError(error.message);
                    return null;
                }
            }

            // Function to display an error message
            function displayError(message) {
                if (loadingElement) {
                    loadingElement.remove();
                }
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `<p>Failed to load YouTube playlist: ${message}</p>`;
                rootElement.appendChild(errorDiv);
            }

            // Function to truncate description at Charleston Church URL
            function truncateDescription(description) {
                if (!description) return 'No description available.';
                
                const charlestonRegex = /https?:\/\/charlestonchurch/i;
                const match = description.match(charlestonRegex);
                
                if (match) {
                    return description.substring(0, match.index).trim();
                }
                
                return description;
            }

            // Function to render the playlist accordion
            async function renderPlaylist() {
                return new Promise((resolve, reject) => {
                    const apiCall = async () => {
                        try {
                            const playlistDetails = await fetchPlaylistDetails();
                            if (!playlistDetails) {
                                reject(new Error('Failed to fetch playlist details'));
                                return;
                            }

                            let allVideos = [];
                            let pageToken = '';
                            do {
                                const data = await fetchPlaylistItems(pageToken);
                                if (!data) {
                                    reject(new Error('Failed to fetch playlist items'));
                                    return;
                                }
                                allVideos = allVideos.concat(data.items);
                                pageToken = data.nextPageToken;
                            } while (pageToken);

                            if (loadingElement && loadingElement.parentNode) {
                                loadingElement.remove();
                            }

                            // Sort videos based on the 'order' parameter
                            if (order === "reverseChronological") {
                                allVideos.sort((a, b) => new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));
                            } else if (order === "alpha") {
                                allVideos.sort((a, b) => a.snippet.title.localeCompare(b.snippet.title));
                            } else { // default to chronological
                                allVideos.sort((a, b) => new Date(a.snippet.publishedAt) - new Date(b.snippet.publishedAt));
                            }

                // Create main accordion container with styling
                const accordionContainer = document.createElement('div');
                accordionContainer.className = 'accordion-container';
                accordionContainer.style.border = '1px solid yellow';
                accordionContainer.style.padding = '10px';

                // Create playlist header (always visible)
                const playlistHeader = document.createElement('div');
                playlistHeader.className = 'playlist-header';
                playlistHeader.innerHTML = `
                    <h2>${playlistDetails.title}</h2>
                    <img src="${playlistDetails.thumbnails.medium.url}" alt="${playlistDetails.title}">
                    <button class="toggle-btn">Show ${playlistDetails.title} Videos</button>
                `;

                // Create videos container (initially hidden)
                const videosContainer = document.createElement('div');
                videosContainer.className = 'videos-container';
                videosContainer.style.display = 'none';

                // Create video items
                allVideos.forEach((video, index) => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';
                    
                    // Create video title link
                    const videoTitle = document.createElement('a');
                    videoTitle.href = '#';
                    videoTitle.textContent = `Video Title: ${video.snippet.title}`;
                    videoTitle.className = 'video-title-link';
                    
                    // Create video content container (initially hidden)
                    const videoContent = document.createElement('div');
                    videoContent.className = 'video-content';
                    videoContent.style.display = 'none';
                    
                    // Format publish date
                    const publishDate = new Date(video.snippet.publishedAt).toLocaleDateString();
                    
                    // Truncate description at Charleston Church URL
                    const truncatedDescription = truncateDescription(video.snippet.description);
                    
                    // Create description and date container (initially visible when video list is shown)
                    const videoMeta = document.createElement('div');
                    videoMeta.className = 'video-meta-info';
                    videoMeta.innerHTML = `
                        <p><strong>Published:</strong> ${publishDate}</p>
                        <p><strong>Description:</strong> ${truncatedDescription}</p>
                    `;
                    
                    // Create video embed container (only shown when video title is clicked)
                    const videoEmbed = document.createElement('div');
                    videoEmbed.className = 'video-embed';
                    videoEmbed.style.display = 'none';
                    videoEmbed.innerHTML = `
                        <iframe 
                            src="https://www.youtube.com/embed/${video.contentDetails.videoId}?autoplay=1"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    `;
                    
                    // Add click event to video title
                    videoTitle.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (videoEmbed.style.display === 'none') {
                            // Hide description/date and show video
                            videoMeta.style.display = 'none';
                            videoEmbed.style.display = 'block';
                        } else {
                            // Show description/date and hide video
                            videoMeta.style.display = 'block';
                            videoEmbed.style.display = 'none';
                        }
                    });
                    
                    videoItem.appendChild(videoTitle);
                    videoItem.appendChild(videoMeta);
                    videoItem.appendChild(videoEmbed);
                    
                    // Add horizontal line after each video (except the last one)
                    if (index < allVideos.length - 1) {
                        const hr = document.createElement('hr');
                        hr.style.borderColor = 'yellow';
                        hr.style.borderWidth = '1px';
                        videoItem.appendChild(hr);
                    }
                    
                    videosContainer.appendChild(videoItem);
                });

                // Add toggle functionality to playlist header button
                const toggleBtn = playlistHeader.querySelector('.toggle-btn');
                toggleBtn.addEventListener('click', function() {
                    if (videosContainer.style.display === 'none') {
                        videosContainer.style.display = 'block';
                        toggleBtn.textContent = `Hide ${playlistDetails.title} Videos`;
                    } else {
                        videosContainer.style.display = 'none';
                        toggleBtn.textContent = `Show ${playlistDetails.title} Videos`;
                        // Hide all expanded videos and show meta info when hiding the list
                        const allVideoEmbeds = videosContainer.querySelectorAll('.video-embed');
                        const allVideoMeta = videosContainer.querySelectorAll('.video-meta-info');
                        allVideoEmbeds.forEach(embed => {
                            embed.style.display = 'none';
                        });
                        allVideoMeta.forEach(meta => {
                            meta.style.display = 'block';
                        });
                    }
                });

                            accordionContainer.appendChild(playlistHeader);
                            accordionContainer.appendChild(videosContainer);
                            rootElement.appendChild(accordionContainer);
                            
                            resolve();
                        } catch (error) {
                            console.error('Error in renderPlaylist:', error);
                            displayError(error.message);
                            reject(error);
                        }
                    };
                    
                    // Add to queue
                    window.youtubePlaylistQueue.push(apiCall);
                    processApiQueue();
                });
            }

            // Start the rendering process
            renderPlaylist().catch(error => {
                console.error('Failed to render playlist:', error);
            });
        });
    </script>
{{ end }}