{{/* layouts/shortcodes/recent-videos.html */}}
{{- $serverUrl := .Get "server_url" | default "/.netlify/functions/server" -}}
{{- $title := .Get "title" | default "üé• Recent Videos" -}}
{{- $subtitle := .Get "subtitle" | default "Latest videos from the past month" -}}

<div class="recent-videos-container">
    <div class="recent-videos-header">
        <h2 class="recent-videos-title">{{ $title }}</h2>
        <p class="recent-videos-subtitle">{{ $subtitle }}</p>
    </div>
    
    <div id="rv-loading" class="recent-videos-loading">
        <div>üîÑ Loading recent videos...</div>
    </div>
    
    <div id="rv-error" class="recent-videos-error" style="display: none;"></div>
    <div id="rv-summary" class="recent-videos-summary" style="display: none;"></div>
    <div id="rv-videos" class="recent-videos-videos" style="display: none;"></div>
    
    <div class="recent-videos-last-updated" id="rv-lastUpdated" style="display: none;"></div>
</div>

<style>
.recent-videos-container {
    margin: 2rem 0;
}

.recent-videos-header {
    text-align: center;
    margin-bottom: 2rem;
}

.recent-videos-title {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.recent-videos-subtitle {
    color: var(--text-muted, #666);
    font-size: 1.1rem;
    margin: 0;
}

.recent-videos-loading {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted, #666);
    font-size: 1.2rem;
}

.recent-videos-error {
    background: var(--error-bg, #fee);
    border: 1px solid var(--error-border, #fcc);
    color: var(--error-text, #c66);
    padding: 1rem;
    border-radius: 0.5rem;
    margin: 1rem 0;
}

.recent-videos-summary {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 2rem;
    border-radius: 1rem;
    margin: 2rem 0;
    text-align: center;
}

.recent-videos-summary h3 {
    margin: 0 0 1.5rem 0;
    color: var(--text-primary, #333);
    font-size: 1.4rem;
}

.recent-videos-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.recent-videos-summary-item {
    background: rgba(255, 255, 255, 0.8);
    padding: 1.5rem;
    border-radius: 0.75rem;
    transition: transform 0.3s ease;
}

.recent-videos-summary-item:hover {
    transform: translateY(-5px);
}

.recent-videos-summary-number {
    font-size: 2rem;
    font-weight: bold;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.recent-videos-summary-label {
    color: var(--text-muted, #666);
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

.recent-videos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.recent-videos-card {
    background: var(--card-bg, white);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: var(--card-shadow, 0 4px 15px rgba(0,0,0,0.1));
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid var(--border-color, #e0e0e0);
}

.recent-videos-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--card-shadow-hover, 0 8px 25px rgba(0,0,0,0.15));
}

.recent-videos-thumbnail {
    width: 100%;
    height: 200px;
    object-fit: cover;
    cursor: pointer;
    transition: opacity 0.3s ease;
}

.recent-videos-thumbnail:hover {
    opacity: 0.9;
}

.recent-videos-content {
    padding: 1.5rem;
}

.recent-videos-video-title {
    font-weight: bold;
    color: var(--text-primary, #333);
    margin-bottom: 1rem;
    font-size: 1.1rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.recent-videos-meta {
    margin-bottom: 0.5rem;
}

.recent-videos-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    font-weight: 500;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.recent-videos-playlist-badge {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.recent-videos-old-testament {
    background: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
}

.recent-videos-new-testament {
    background: #e1f5fe;
    color: #0277bd;
    border: 1px solid #b3e5fc;
}

.recent-videos-other-series {
    background: #f3e5f5;
    color: #7b1fa2;
    border: 1px solid #e1bee7;
}

.recent-videos-date {
    color: var(--text-muted, #666);
    font-size: 0.9rem;
    margin-top: 0.75rem;
}

.recent-videos-actions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color, #eee);
}

.recent-videos-link {
    color: var(--link-color, #667eea);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
}

.recent-videos-link:hover {
    color: var(--link-hover-color, #764ba2);
}

.recent-videos-last-updated {
    text-align: center;
    color: var(--text-muted, #888);
    font-size: 0.9rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color, #eee);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .recent-videos-grid {
        grid-template-columns: 1fr;
    }
    
    .recent-videos-summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .recent-videos-title {
        font-size: 2rem;
    }
}
</style>

{{ $jsCode := printf `
(function() {
    var SERVER_URL = '%s';
    
    function rvDisplaySummary(videos) {
        var categoryCounts = videos.reduce(function(acc, video) {
            acc[video.category] = (acc[video.category] || 0) + 1;
            return acc;
        }, {});

        var summaryHtml = '<h3>üìä Recent Videos Summary</h3>' +
            '<div class="recent-videos-summary-grid">' +
                '<div class="recent-videos-summary-item">' +
                    '<div class="recent-videos-summary-number">' + videos.length + '</div>' +
                    '<div class="recent-videos-summary-label">Recent Videos</div>' +
                '</div>' +
                '<div class="recent-videos-summary-item">' +
                    '<div class="recent-videos-summary-number">' + (categoryCounts['Old Testament'] || 0) + '</div>' +
                    '<div class="recent-videos-summary-label">Old Testament</div>' +
                '</div>' +
                '<div class="recent-videos-summary-item">' +
                    '<div class="recent-videos-summary-number">' + (categoryCounts['New Testament'] || 0) + '</div>' +
                    '<div class="recent-videos-summary-label">New Testament</div>' +
                '</div>' +
                '<div class="recent-videos-summary-item">' +
                    '<div class="recent-videos-summary-number">' + (categoryCounts['Other Series'] || 0) + '</div>' +
                    '<div class="recent-videos-summary-label">Other Series</div>' +
                '</div>' +
            '</div>';

        var summaryDiv = document.getElementById('rv-summary');
        summaryDiv.innerHTML = summaryHtml;
        summaryDiv.style.display = 'block';
    }

    function rvDisplayVideos(videos) {
        if (videos.length === 0) {
            document.getElementById('rv-videos').innerHTML = '<div class="recent-videos-error">No videos found from the last month.</div>';
            document.getElementById('rv-videos').style.display = 'block';
            return;
        }

        var sortedVideos = videos.sort(function(a, b) {
            return new Date(b.publishedAt) - new Date(a.publishedAt);
        });

        var videosHtml = '<div class="recent-videos-grid">' +
            sortedVideos.map(function(video) {
                var publishedDate = new Date(video.publishedAt);
                var formattedDate = publishedDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                var categoryClass = 'recent-videos-other-series';
                if (video.category === 'Old Testament') {
                    categoryClass = 'recent-videos-old-testament';
                } else if (video.category === 'New Testament') {
                    categoryClass = 'recent-videos-new-testament';
                }
                
                var playlistBadge = video.playlistTitle ? 
                    '<span class="recent-videos-badge recent-videos-playlist-badge">' + video.playlistTitle + '</span>' : '';
                
                return '<div class="recent-videos-card">' +
                    '<img src="' + video.thumbnailUrl + '" alt="' + video.title.replace(/"/g, '&quot;') + '" class="recent-videos-thumbnail" onclick="window.open(\'' + video.url + '\', \'_blank\')" />' +
                    '<div class="recent-videos-content">' +
                        '<div class="recent-videos-meta">' +
                            playlistBadge +
                            '<span class="recent-videos-badge ' + categoryClass + '">' + video.category + '</span>' +
                        '</div>' +
                        '<h3 class="recent-videos-video-title">' + video.title + '</h3>' +
                        '<div class="recent-videos-date">üìÖ ' + formattedDate + '</div>' +
                        '<div class="recent-videos-actions">' +
                            '<a href="' + video.url + '" target="_blank" class="recent-videos-link">‚ñ∂Ô∏è Watch on YouTube</a>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('') +
        '</div>';

        var videosDiv = document.getElementById('rv-videos');
        videosDiv.innerHTML = videosHtml;
        videosDiv.style.display = 'block';
    }

    function rvShowError(message) {
        var errorDiv = document.getElementById('rv-error');
        errorDiv.innerHTML = '<strong>Error:</strong> ' + message;
        errorDiv.style.display = 'block';
    }

    function rvHideLoading() {
        document.getElementById('rv-loading').style.display = 'none';
    }

    function rvShowLastUpdated() {
        var now = new Date();
        var formattedTime = now.toLocaleString();
        var lastUpdatedDiv = document.getElementById('rv-lastUpdated');
        lastUpdatedDiv.innerHTML = '‚è∞ Last updated: ' + formattedTime;
        lastUpdatedDiv.style.display = 'block';
    }

    function rvLoadRecentVideos() {
        fetch(SERVER_URL + '/recent-videos')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(function(data) {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.videos || !Array.isArray(data.videos)) {
                    throw new Error('Invalid response format: videos array not found');
                }
                
                rvHideLoading();
                rvDisplaySummary(data.videos);
                rvDisplayVideos(data.videos);
                rvShowLastUpdated();
            })
            .catch(function(error) {
                console.error('Error loading recent videos:', error);
                rvHideLoading();
                rvShowError('Failed to load videos: ' + error.message);
            });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', rvLoadRecentVideos);
    } else {
        rvLoadRecentVideos();
    }
})();
` $serverUrl }}

<script>{{ $jsCode | safeJS }}</script>